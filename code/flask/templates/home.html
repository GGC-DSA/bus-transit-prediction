<head>

 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>

 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>





<link rel = "stylesheet" type="text/css" href = "{{url_for('static',filename='style.css')}}">

<!-- dropdown utils-->
<script src="{{url_for('static',filename='drop.js')}}"></script>

<link rel = "stylesheet" type="text/css" href = "{{url_for('static',filename='dropDown.css')}}">


<!-- BusMap heigh styling --> 
 <style>
 #busMap{
 height:700px;
 }
 </style>

</head>

<!-- main webpage section -->

<body>

<div class="header">
   <div class = "outColumn">
       <image src="{{url_for('static',filename='images/ggc_logo.png')}}">
   </div>
    <div class = "columnH">
        <h1>MARTA Bus Transit Prediction Project</h1>
        <h2><b>Made by Team BusNet</b></h2>
    </div>
    <div class = "outColumn">
          <image src="{{url_for('static',filename='images/busNet.png')}}">
    </div>

</div>

<div class="topnav">
  <a href="/Code">Code</a>
  <a href="/AboutUs">About Us</a>
  <a href="/Data">Data</a>
 <!-- <a href="#" style="float:right">Link</a>  -->
</div>

<!--   Map Place HERE -->
<div class="row">
  <div class="leftcolumn">
    <div class="card">
      <h2>MARTA Bus Prediction Map Powered By "Long short-term Memory Recursive Neural Network"</h2>

      Data last updated At: <b>{{update_time}}</b>
      <br>There are currently <b>{{home_annoc[0]}}</b> buses running across <b>{{home_annoc[1]}}</b> routes
      <br>
       
      
            
      <div id="busMap"></div>
      
      
      
      
      
      <script>
           
          
           
           
            //south,north,east,west
          /* #TODO  fix issues with custom icon defining and utilize custom directional icons.
           south = L.icon({
           iconUrl:"{{url_for('static',filename='images/marta_logo_n_res.png')}}",
           shadowUrl:"{{url_for('static',filename='images/marta_logo_gen_res.png')}}",
           iconSize:[146,27],
           shadowSize:[146,27],
           iconAnchor:[60,15],
           shadowAnchor:[60,15],
           popupAnchor:[0,10]
           })
           */
      
           //sets location (lon lat zoom) for initial map position
           const myMap = L.map('busMap').setView([33.7490,-84.3880],11);
           
           var value = {{value|safe}}
           var stops = {{stops|safe}}
           
           //console.log(value.get(0));
           
           //required attribution for tiler
           const attribution = 
                 '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
           
           //tile utility api link
           const tile_url = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
           
           //collect tiles
           const tiles = L.tileLayer(tile_url,{attribution})
           
           //build map
           tiles.addTo(myMap);
           
           //add markers
           
           var busIcon = L.icon({
           iconUrl: "{{url_for('static',filename='images/bus.png')}}",
           iconSize: [48,48],
           iconAnchor: [24,48],
           popupAnchor:[0,-28]});
           
           
           var stopIcon = L.icon({
           iconUrl: "{{url_for('static',filename='images/bus-stop.png')}}",
           iconSize: [32,32],
           iconAnchor: [16,32],
           popupAnchor:[0,-16]});
           
           var routeIcon = L.icon({
           iconUrl: "{{url_for('static',filename='images/map.png')}}",
           iconSize:[32,32],
           iconAnchor: [16,32],
           popupAnchor:[0,-16]});
           
           //layer declaration
           
           var mainLayer = L.layerGroup();
           
           var dynamicLayer = L.layerGroup();
           
           
           //method declarations
           
           
           var stopBuild = function(valueID,ifAdherence){
           
           routeID = value[valueID][4];
           
           if(ifAdherence){
                 vehicleID = value[valueID][2];
           }
           //builds stop markers
                 for(var i=0;i<stops.length;i++){
                 
                       if(stops[i][3]==routeID){
                       
                            marker = L.marker([stops[i][1],stops[i][0]],{icon:stopIcon});
                            marker.bindPopup("<b>Stop <br> ID:</b> "+stops[i][2]+"<br> <b>Route:</b> "+stops[i][3]);
                            dynamicLayer.addLayer(marker); 
                            
                            if(ifAdherence){
                            
                                  textMarker = L.marker([stops[i][1]-.005,stops[i][0]],
                                        {icon: L.divIcon({
                                              html: String(stops[i][4][String(vehicleID)]),
                                              className:'text-below-marker'})
                                  });
                                  
                                  dynamicLayer.addLayer(textMarker);
                            
                            }
                       }
                 
                 
                 }
           }
           
           
           
           
           
           
           
           
           
           //erases content of layer (also essentially lowers "level" of layer)
           var mapClear = function(layer){
                 layer.clearLayers();
           }
           
           
           
           
          
           
           
           //TODO add vehicle from route selection option
           
           var buildVehicle = function(vehicleNum){
                 mapClear(dynamicLayer);
               
                 vehicleAr = value[vehicleNum]
                     
                 marker = L.marker([vehicleAr[1],vehicleAr[0]],{icon:busIcon});
                 marker.bindPopup("<b>Vehicle <br> ID:</b> "+vehicleAr[2]+"<br> <b>Route:</b> "+vehicleAr[4]
                       +"<br> <b> Direction:</b> "+vehicleAr[3] );
                 dynamicLayer.addLayer(marker);
           
                 stopBuild(vehicleNum,true);
                 mapClear(mainLayer);
                 dynamicLayer.addTo(myMap);
           }
           
           
           
           
            //TODO Copy button functionality from buildMain...
           
           var buildRoute = function(routeID){
                routeID = parseInt(routeID);
               // alert("hi : "+routeID)
                mapClear(dynamicLayer);
               //builds bus markers
                 Ihold = 666
                 for(var i=0;i<value.length;i++){
                       
                       
                       if(value[i][4]==routeID){
                             Ihold = i   
                             marker = L.marker([value[i][1],value[i][0]],{icon:busIcon});
                             marker.bindPopup("<b>Vehicle <br> ID:</b> "+value[i][2]+"<br> <b>Route:</b> "+value[i][4]
                                   +"<br> <b> Direction:</b> "+value[i][3]+"<br> <button"+' onclick="buildVehicle('+i+')">'
                                   +"Select Vehicle</button>");
                             
                             dynamicLayer.addLayer(marker);
                             
                             
                 
                       }
                 }
                 if(Ihold != 666){
                     stopBuild(Ihold,false);
                 }
                 else{
                     alert("Warning! The route you selected : "+routeID+ " Does not have any buses servicing it when we last collected data."
                     +" <br> <b>Click on the Return Button to Return to The Main Map. ");
                 }
                 
                 mapClear(mainLayer);
                 dynamicLayer.addTo(myMap);
                 
                 
           }
           
           
           
           
           
           //WORKS !! :) Old Code here 
           
           var mainMapBuilderOld= function(){
                 mapClear(mainLayer);
                 mapClear(dynamicLayer);
                 for(var i=0;i<value.length;i++){
                       //console.log(value.get(i));
                       //{Icon:south}
                       marker = L.marker([value[i][1],value[i][0]],{icon:routeIcon});
                       marker.bindPopup("<b>Vehicle <br> ID:</b> "+value[i][2]+"<br> <b>Route:</b> "+value[i][4]
                             +"<br> <b> Direction:</b> <br> "+value[i][3]+"<br> <button"+' onclick="buildRoute('+value[i][4]+')">'
                             +"Select Route</button>");
                       mainLayer.addLayer(marker);
                       
                
           }
                 mainLayer.addTo(myMap);
           }
           
           
           
           //start main map view
          //mainMapBuilder()
          // deprecated....mainLayer.addTo(myMap)
          
          
          var mainMapBuilder = function(){
          
                mapClear(mainLayer);
                mapClear(dynamicLayer);
                
    
                dupeList = {};
                
                for(var j=0;j<stops.length;j++){
                    stop = stops[j];
                    routeStr = String(stop[3]);
                   // alert(routeStr);
                    if(routeStr in Object.keys(dupeList)){
                        
                        lister = dupeList[routeStr];
                        dupeList[routeStr] = [lister[0]+1,[(lister[1][0]*lister[0]/(lister[0]+1))+stop[0]/(lister[0]+1),
                            (lister[1][1]*lister[0])/(lister[0]+1)+(stop[1]/(lister[0]+1))]];
                    }
                    else{
                        dupeList[routeStr] = [1,[ stop[0],stop[1] ]];
                    }
                    
                    
                }
                
                //alert(Object.keys(dupeList));
                Object.keys(dupeList).forEach(key => {
  
                    marker = L.marker([dupeList[key][1][1]-2,dupeList[key][1][0]],{icon:routeIcon});
                    
                     marker.bindPopup("<b>Route</b> <br> <b>RouteID:</b> "+key
                             +"<br> <button onclick=buildRoute("+key+")>"
                             +"Select Route</button>");
                     mainLayer.addLayer(marker);
  
                });
                mainLayer.addTo(myMap);
          }
           
      mainMapBuilder();
          
      </script>
      
      <!--<script src="{{url_for('static',filename='mapper.js')}}"></script>-->
      
      
     
    </div>

</div>


<!-- End buttons / start side bars -->
  <div class="rightcolumn">
    <div class="card">
      <h1>How To Use</h1>
      <h3>Step 1: Select a Route</h3>
     <p>click on the map icon to select a specific route to look at <image src="{{url_for('static',filename='images/map.png')}}"></p>
     <h3>Step 2: Select a Vehicle</h3>
     <p> click on a bus to choose the specific vehicle to look at the predicted values for </p> <image src="{{url_for('static',filename='images/bus.png')}}">
     <h3>Step 3: Look at the predicted adherence</h3>
     <p> adherence represents the #of minutes the bus is predicted to arrive <b>early/late</b> (<b>positive/negative</b>).</p>
     <center> <button onclick="mainMapBuilder()">Return To Main Map</button></center>
    </div>
   
  </div>
</div>

<div class="footer">
  <h2>SST, GGC Logos?</h2>
  <div>Icons made by <a href="https://www.flaticon.com/authors/xnimrodx" title="xnimrodx">xnimrodx</a>, and <a href="https://www.flaticon.com/authors/pixel-perfect">Pixel perfect</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>

  <!--<div class="fakeimg">-->
     <!--   <image src="{{url_for('static',filename='images/ggc_ad.png')}}"> -->
 <!-- </div>-->
</div>

</body>

